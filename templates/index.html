{% extends "layout.html" %}

{% block title %}
    Index
{% endblock %}

{% block main %}
    <div class="row">        
        <div class="col-3 container">
            <div id="userInterface">
                <div id="select">
                    <p>Please select a station and time</p>
                    <select id="stations" name="stations" style="margin-left: 10px";></select>
                    <select id="hour" name="hour"></select>
                    <input id="predict" type="button" value="Select">
                    <div id="result"></div>
                </div>
                <div id="filters">
                    <div id="filter1">
                        <!--    label for the parking slot toggle switch-->
                        <label style='font-family: sans-serif;'>Free parking stations:</label>
                        <!--    declare a input type checkbox for available parking slots which acts a toggle switch using css-->
                        <label class="toggle">
                            <input id="slideparking" type="checkbox" display="none" onclick="slideparking_click()"><span class="slider"></span>
                        </label>
                    </div>
                    <div id="filter2">
                        <!--    label for the available bikes toggle switch-->
                        <label style='font-family: sans-serif;'>Free bikes:</label>
                        <!--    declare another input type checkbox for available bikes which acts a toggle switch using css-->
                        <label class="toggle">
                            <input id="slidebikeavailable" type="checkbox" display="none" onclick="slidebikeavailable_click()"><span class="slider"></span>
                        </label>
                    </div> 
                </div>
                <div id="weather">
                    {% for post in posts %}
                    <div style='float: left;'>
                        <img src={{post[2]}} alt='weather icon'>
                    </div>
                    <div style='float: left;'>
                        <p style='font-size: 40px;'>{{post[8]}}&#176C</p>
                        <p style='font-size: 20px;'>{{post[3]}}</p>
                    </div>
                    <div style='clear: both; text-align: center;'>
                        <p><b>Cloud cover: </b>{{post[1]}}%</p>
                        <p><b>Precipitation: </b>{{post[7]}}</p>
                        <p><b>Wind speed: </b>{{post[9]}}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-9 container">
            <div id="floating-panel">
                <b>Mode of Travel: </b>
                <select id="mode">
                    <option value="DRIVING">Driving</option>
                    <option value="WALKING">Walking</option>
                    <option value="BICYCLING">Bicycling</option>
                    <option value="TRANSIT">Transit</option>
                </select>
            </div>
            <div id="NearstStation"></div>
            <div id="map"></div>
        </div>
        
    </div>

    <div id="ChartDetails">
        <label id="stationDetails"></label>
    </div>
    <div id="chart_div"></div>
    <div id="HourlyChart"></div>
        
    <footer><p>Copyright &copy; 2009-2021 Dublin Bikes</p></footer>

    <script>
        // populate time dropdown with remaining hours of the day
         window.onload = function (e) {
                createTimeDropdown('#hour');
         }      
        // create a variable to check the status of the switch
        var parking_slots_filter = false;
        var bikes_available_filter = false;
        // create a function to show the markers acc. to choice made
        function slidebikeavailable_click(){
        // check if the switch is on, apply status to variable and call the map function
            if(document.getElementById("slidebikeavailable").checked == true){
                bikes_available_filter = true;
            }
            else{
                bikes_available_filter = false;
            }
            initMap();
        }
        function slideparking_click(){
            if(document.getElementById("slideparking").checked == true){
                parking_slots_filter = true;
            }
            else{
                parking_slots_filter = false;
            }
            initMap();
        }

        function initChart(){
            google.charts.load("current", {packages:["corechart"]});
            google.charts.setOnLoadCallback(initMap);
        }

        function initMap() {
            // this result is cached using lru_cache decorator
            // static and dynamic arrays logged to console are within the scope of map marker and info window functions
            fetch("/stations").then(response => {
                return response.json();
            }).then(static => {
                console.log(static);
                // map centered on Dublin
                map = new google.maps.Map(document.getElementById("map"), {
                    center: {lat: 53.3470, lng: -6.2603},
                    zoom: 13.5,
                });
                
                var directionsService = new google.maps.DirectionsService;
                var directionsDisplay = new google.maps.DirectionsRenderer;
                var myLatLng;
                directionsDisplay.setMap(map);

                // insert current location marker on map    
                var duplicate_marker = false;
                infoWindow = new google.maps.InfoWindow();
                const locationButton = document.createElement("button");
                locationButton.innerHTML = '<img class="ImgCurr" src="{{url_for('static', filename='CurrentLocation.png')}}" title="View current location" alt="Current Location"/>';
                locationButton.className = "CurrMarker";
                locationButton.classList.add("custom-map-control-button");
                map.controls[google.maps.ControlPosition.TOP_RIGHT].push(locationButton);
                locationButton.addEventListener("click", () => {
                    if(duplicate_marker){
                        duplicate_marker = false;
                    }
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            myLatLng = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            var icon = {
                            url: "{{url_for('static', filename='Curr_location_marker.png')}}",
                            scaledSize: new google.maps.Size(30, 40),
                            };
                            const marker = new google.maps.Marker({
                            position: { lat: position.coords.latitude, lng: position.coords.longitude},
                            icon: icon,
                            map:map,
                            });
                            duplicate_marker = marker;
                            infoWindow.setPosition(pos);
                            infoWindow.setContent("Location found.");
                            infoWindow.open(map);
                            map.setCenter(pos);
                        },
                        () => {
                          handleLocationError(true, infoWindow, map.getCenter());
                        }
                      );
                    } else {
                        handleLocationError(false, infoWindow, map.getCenter());
                       }
                });

                fetch("/dynamic").then(response => {
                    return response.json();
                }).then(dynamic => {
                    console.log(dynamic);
                let i = 0;
                static.forEach(station => {
                    dropDownList = document.getElementById("stations");
                    // populate select element with station options
                    var stOp = document.createElement("option");
                    stOp.setAttribute("value",station.num);
                    stOp.setAttribute("label",station.name);
                    dropDownList.appendChild(stOp);
                    // function to create marker colour proportional to free stands
                    function getIcon(totalStands,bikesFree) {
                        if (bikesFree/totalStands > 0.6) {
                            return "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                        }
                        else if (bikesFree/totalStands < 0.3) {
                            return "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                        }
                        else {
                            return "http://maps.google.com/mapfiles/ms/icons/orange-dot.png"
                        }
                    } 
                    // create unique marker for each station
                    const marker = new google.maps.Marker({
                        position: {lat: station.latitude, lng: station.longitude},
                        icon: getIcon(dynamic[i].bike_stands,dynamic[i].bikes_free),  
                        map: map});
                        // create an info window to display station and dynamic information
                            var infowindow = new google.maps.InfoWindow({
                                content: '<h3>'+station.name+'</h3><p><b>Total stands</b></p><p>'+dynamic[i].bike_stands+'</p>'+'<p><b> Available bikes </b></p><p>'+dynamic[i].bikes_free+'</p>'+'<p><b>Parking slots</b></p><p>'+dynamic[i].stands_free,
                            });

                        // check if the variable is true and if the bike stands for any of the station is 0
                        if(parking_slots_filter == true && station.stands_free == 0){
                        // if any of the station is not having parking slots, then hide that station marker
                            marker.setVisible(false);
                        }
                        // check if available bikes variable is true and if any station with available bikes as 0
                        if(bikes_available_filter == true && station.bikes_free == 0){
                        // if any of the station is not having parking slots, then hide that station marker
                            marker.setVisible(false);
                        }
                        // add event listeners to map markers
                        google.maps.event.addListener(marker,"mouseover",function() {
                            infowindow.open(map,marker);
                        })
                        google.maps.event.addListener(marker,"mouseout",function() {
                            infowindow.close();
                        })
                        google.maps.event.addListener(marker,"click",function() {
                            WeeklyChart(station.num);
                            HourlyChart(station.num);
                            calculateAndDisplayRoute(directionsService, directionsDisplay, marker.getPosition().lat(), marker.getPosition().lng());
                        })
                    i++;
                    })

                    function calculateAndDisplayRoute(directionsService, directionsDisplay, Destination_Lat, Destination_lng){
                        const selectedMode = document.getElementById("mode").value;
                        let request = {
                            origin: myLatLng,
                            destination: {
                                lat: Destination_Lat,
                                lng: Destination_lng
                            },
                            travelMode: google.maps.TravelMode[selectedMode]
                        };

                        directionsService.route(request, function(response, status) {
                            if(status === 'OK') {
                                directionsDisplay.setDirections(response);
                            }else{
                                window.alert('Direction request failed due to '+ status);
                            }
                        });
                    }
                    // Assign onclick handler to the Submit button.
                    document.getElementById("predict").onclick = function () {
                        selStat = getSelectedStation();
                        numStat = parseInt(selStat,10);
                        hour = getSelectedHour();
                        predictBikes(numStat,hour);
                        // zoom and center the map on the selected station
                        for (station of static) {
                            if (station.num == numStat) {
                                var lat = parseFloat(station.latitude,10);
                                var lng = parseFloat(station.longitude,10);
                                latlng = new google.maps.LatLng(lat,lng);
                                map.setZoom(16);
                                map.setCenter(latlng);
                            }
                        }
                    }
            })});
        }
        // Functions
        // function to populate time dropdown menu
        function createTimeDropdown(selector){
            var select = $(selector);
            var today = new Date();
            var time = today.getHours();
            for (var i=time + 1; i<24; i++) {
                var hour = i;
                var ampm = hour >= 12 ? 'PM' : 'AM';
                if (hour != 12) {
                    hour = hour % 12;
                }
                select.append($('<option></option>')
                .attr('value', i)
                .text(hour + ":00" + ampm));
            }
        }
        // function to get the station that is selected in the dropdown list
        function getSelectedStation() {
            var statSel = document.getElementById("stations");
            var statSelLen = statSel.options.length;
            for (var i=0; i<statSelLen; i++) {
                opt = statSel.options[i];
                if (opt.selected === true) {
                    break;
                }
            }
            return opt.value;
        }
        // function to get the time that is selected in the dropdown list
        function getSelectedHour() {
            var selHour = document.getElementById("hour");
            var hourSelLen = selHour.options.length;
            for (var i=0; i<hourSelLen; i++) {
                opt = selHour.options[i];
                if (opt.selected === true) {
                    break;
                }
            }
            return opt.value;
        }
        // send the station number to the url and execute the query in app.py page
        function WeeklyChart(station_number){
            fetch("/occupancy/"+station_number).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);

            var StationName = "";
            var MaxBikes = 0;
            var count = 0;
            var iterationCount = 0;

            // store week days in an array to represent them on x-axis as they are unordered in the json data
            var WeeklyDays = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
            var AvgBikes_Week = [];

                // loop the above array and sum all the values and take the average and store the result in a array
                for(var i=0; i<WeeklyDays.length; i++){
                    data.forEach(obj => {
                            if(obj.Week_Day_No == WeeklyDays[i]){
                                StationName = obj.name;
                                MaxBikes = obj.Avg_bike_stands;
                                count = count + obj.Avg_bikes_free;
                                iterationCount = iterationCount + 1;
                            }
                    })
                    AvgBikes_Week.push(Math.floor(count/iterationCount));
                    console.log("The total count for ",WeeklyDays[i]," is ",Math.floor(count/iterationCount));
                    count = 0;
                    iterationCount = 0;
                }

                // display the selected station and max stands available in div
                var node = document.getElementById('stationDetails');
                node.innerHTML = "<p><b>Selected station : </b>"+StationName+".<br><b>The maximum bikes available : </b>"+MaxBikes+"</p>";

                var options = {
                    animation: {
                      duration: 1500,
                      easing: 'linear',
                      startup: true
                    },
                    curveType: 'function',
                    colors: ['black'],
                    legend: 'none',
                    height: 250,
                    tooltip: { isHtml: true },
                    hAxis: {
                        slantedText: true,
                        slantedTextAngle: 45
                    },
                     vAxis: {
                        title: 'Avg bikes available',
                        titleTextStyle: { italic: false, fontName: 'Calibri', fontSize: '20', bold: 'true' },
                    },
                    chartArea: {
                        width: '64%'
                    },
                    title: "Weekly availability data",
                    titleTextStyle: { italic: true, fontName: 'Calibri', fontSize: '20', bold: 'true' },
                    width: '1200',
                    height: '500'
                }
                var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
                var chart_data = new google.visualization.DataTable();

                // provide the data type and value name in the below line
                chart_data.addColumn('string', "Week_Day_No");
                chart_data.addColumn('number' ,"Avg_bikes_free" );

                // loop through all the days in a week and display the avg
                for(var i=0; i<WeeklyDays.length; i++){
                    chart_data.addRow([WeeklyDays[i], AvgBikes_Week[i]]);
                }
                chart.draw(chart_data, options);
            });

        }

        function HourlyChart(station_number){
            console.log("This is chart function ",station_number);
            fetch("/hourly/"+station_number).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);

                var options = {
                    animation: {
                      duration: 1500,
                      easing: 'linear',
                      startup: true
                    },
                    curveType: 'function',
                    colors: ['black'],
                    legend: 'none',
                    height: 250,
                    tooltip: { isHtml: true },
                    hAxis: {
                        ticks: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]

                    },
                     vAxis: {
                        title: 'Avg bikes available',
                        titleTextStyle: { italic: false, fontName: 'Calibri', fontSize: '20', bold: 'true' },
                    },
                    chartArea: {

                        width: '64%'
                    },
                    title: "Hourly availability data",
                    titleTextStyle: { italic: true, font: 'Calibri', fontSize: '20', bold: 'true' },
                    width: '1200',
                    height: '500'
                }
                var chart = new google.visualization.LineChart(document.getElementById('HourlyChart'));
                var chart_data = new google.visualization.DataTable();
                chart_data.addColumn('number', "Hour");
                chart_data.addColumn('number' ,"Avg_bikes_free" );

                 data.forEach(v => {
                    chart_data.addRow([v.Hours, v.Avg_bikes_free]);
                 })
                 chart.draw(chart_data, options);
            });
        }
        
        function predictBikes(station_number,hour) {
            fetch("/predict/"+station_number+"/"+hour).then(response => {
                return response.json();
            }).then(data => {
                console.log(data);
                var container = document.getElementById("result");
                container.innerHTML = "<p>Expected number of free bikes: " + data[5] + "</p>" ;        
        })}
</script>

<!-- Async script executes immediately and must be after any DOM elements used in callback. -->
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXGwi384HVo-MXNLWnXcmWYNWujsWi5OI&callback=initChart">
</script>
{% endblock %}